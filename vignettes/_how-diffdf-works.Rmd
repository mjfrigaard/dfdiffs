---
title: "how-diffdf-works"
output: 
  rmarkdown::html_vignette:
    toc: yes
    toc_depth: 4
vignette: >
  %\VignetteIndexEntry{how-diffdf-works}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = TRUE
)
library(shiny)
library(data.table)
library(dplyr)
library(stringr)
library(forcats)
library(lubridate)
library(fs)
library(vctrs)
library(glue)
library(purrr)
library(vroom)
library(haven)
library(readxl)
library(janitor) # compare_df_cols
library(arsenal) # comparedf
library(diffdf) # diffdf
library(testthat) # expect_equal
library(vetr) # alike
library(gt)
```

# diffdf 

This is a breakdown of how the `diffdf::diffdf()` function works. We'll load some test data to see how the supporting functions work, too.

```{r changed-data}
# changed data
base_change_df <- tibble::tribble(
  ~id, ~group, ~var_x, ~var_y, ~var_z,
  1, "A", 5.5, 111L, "notice",
  2, "B", 9, 106L, "admit",
  3, "C", 5.2, 109L, "america",
  4, "A", 4.4, 96L, "try",
  5, "B", 9.1, 116L, "serve",
  6, "C", 6.7, 98L, "because",
)
compare_change_df <- tibble::tribble(
  ~id, ~group, ~var_x, ~var_y, ~var_z,
  1, "A", 5.5, 111L, "notice",
  2, "B", 3.3, 106L, "admit",
  3, "C", 5.2, 109L, "America",
  4, "A", 4.4, 73L, NA_character_,
  5, "B", 9.1, 116L, "serve",
  6, "C", 6.7, 98L, "HiStorY",
)
```

```{r compare-base-join_var}
compare <- mutate(compare_change_df,
  join_var = as.character(row_number())
) |>
  dplyr::relocate(join_var, everything())
base <- mutate(base_change_df,
  join_var = as.character(row_number())
) |>
  dplyr::relocate(join_var, everything())
```

## TESTING_print_msg

```{r TESTING_print_msg}
TESTING_print_msg <- list(
  Identical = "No issues were found!", `Identical 2` = "No issues were found!",
  `Different Values` = c(
    "Differences found between the objects!",
    "", "A summary is given below.", "", "Not all Values Compared Equal",
    "All rows are shown in table below", "", "  ===============================",
    "    Variable   No of Differences ", "  -------------------------------",
    "   CONTINUOUS          3         ", "  -------------------------------",
    "", "", "All rows are shown in table below", "", "  ==============================================",
    "    VARIABLE   ..ROWNUMBER..    BASE    COMPARE ", "  ----------------------------------------------",
    "   CONTINUOUS        1        15.65720     1    ", "   CONTINUOUS        5        26.15303     2    ",
    "   CONTINUOUS        7        16.29289     3    ", "  ----------------------------------------------",
    ""
  ), `Different Values 2` = c(
    "Differences found between the objects!",
    "", "A summary is given below.", "", "Not all Values Compared Equal",
    "All rows are shown in table below", "", "  ===============================",
    "    Variable   No of Differences ", "  -------------------------------",
    "   CONTINUOUS          3         ", "  -------------------------------",
    "", "", "All rows are shown in table below", "", "  ===========================================",
    "    VARIABLE   ..ROWNUMBER..  BASE  COMPARE  ", "  -------------------------------------------",
    "   CONTINUOUS        1         1    15.65720 ", "   CONTINUOUS        5         2    26.15303 ",
    "   CONTINUOUS        7         3    16.29289 ", "  -------------------------------------------",
    ""
  ), `Different attributes` = c(
    "Differences found between the objects!",
    "", "A summary is given below.", "", "There are columns in BASE and COMPARE with differing attributes !!",
    "All rows are shown in table below", "", "  =====================================================================",
    "   VARIABLE  ATTR_NAME  VALUES.BASE             VALUES.COMP            ",
    "  ---------------------------------------------------------------------",
    "    BINARY   something     NULL      list(Sepal.Length = c(5.1, 4.9... ",
    "  ---------------------------------------------------------------------",
    ""
  ), `Different attributes 2` = c(
    "Differences found between the objects!",
    "", "A summary is given below.", "", "There are columns in BASE and COMPARE with differing attributes !!",
    "All rows are shown in table below", "", "  =====================================================================",
    "   VARIABLE  ATTR_NAME             VALUES.BASE             VALUES.COMP ",
    "  ---------------------------------------------------------------------",
    "    BINARY   something  list(Sepal.Length = c(5.1, 4.9...     NULL     ",
    "  ---------------------------------------------------------------------",
    ""
  ), `Different Levels` = c(
    "Differences found between the objects!",
    "", "A summary is given below.", "", "There are columns in BASE and COMPARE with differing attributes !!",
    "All rows are shown in table below", "", "  ============================================================",
    "    VARIABLE    ATTR_NAME    VALUES.BASE       VALUES.COMP    ",
    "  ------------------------------------------------------------",
    "   CATEGORICAL   levels    c(\"A\", \"B\", \"C\")  c(\"A\", \"B\", \"D\") ",
    "  ------------------------------------------------------------",
    "", "Not all Values Compared Equal", "All rows are shown in table below",
    "", "  ================================", "    Variable    No of Differences ",
    "  --------------------------------", "   CATEGORICAL          8         ",
    "  --------------------------------", "", "", "All rows are shown in table below",
    "", "  ===========================================", "    VARIABLE    ..ROWNUMBER..  BASE  COMPARE ",
    "  -------------------------------------------", "   CATEGORICAL        1         C       D    ",
    "   CATEGORICAL        2         C       D    ", "   CATEGORICAL        3         C       D    ",
    "   CATEGORICAL        6         C       D    ", "   CATEGORICAL        7         C       D    ",
    "   CATEGORICAL       15         C       D    ", "   CATEGORICAL       17         C       D    ",
    "   CATEGORICAL       20         C       D    ", "  -------------------------------------------",
    ""
  ), `Different Levels 2` = c(
    "Differences found between the objects!",
    "", "A summary is given below.", "", "There are columns in BASE and COMPARE with differing attributes !!",
    "All rows are shown in table below", "", "  ============================================================",
    "    VARIABLE    ATTR_NAME    VALUES.BASE       VALUES.COMP    ",
    "  ------------------------------------------------------------",
    "   CATEGORICAL   levels    c(\"A\", \"B\", \"D\")  c(\"A\", \"B\", \"C\") ",
    "  ------------------------------------------------------------",
    "", "Not all Values Compared Equal", "All rows are shown in table below",
    "", "  ================================", "    Variable    No of Differences ",
    "  --------------------------------", "   CATEGORICAL          8         ",
    "  --------------------------------", "", "", "All rows are shown in table below",
    "", "  ===========================================", "    VARIABLE    ..ROWNUMBER..  BASE  COMPARE ",
    "  -------------------------------------------", "   CATEGORICAL        1         D       C    ",
    "   CATEGORICAL        2         D       C    ", "   CATEGORICAL        3         D       C    ",
    "   CATEGORICAL        6         D       C    ", "   CATEGORICAL        7         D       C    ",
    "   CATEGORICAL       15         D       C    ", "   CATEGORICAL       17         D       C    ",
    "   CATEGORICAL       20         D       C    ", "  -------------------------------------------",
    ""
  ), `Different Class` = c(
    "Differences found between the objects!",
    "", "A summary is given below.", "", "There are columns in BASE and COMPARE with different classes !!",
    "All rows are shown in table below", "", "  ======================================================",
    "   VARIABLE  CLASS.BASE            CLASS.COMP           ",
    "  ------------------------------------------------------",
    "     DATE       Date     c(\"A_DATE\", \"b_date\", \"cDate\") ",
    "  ------------------------------------------------------",
    ""
  ), `Different Class 2` = c(
    "Differences found between the objects!",
    "", "A summary is given below.", "", "There are columns in BASE and COMPARE with different classes !!",
    "All rows are shown in table below", "", "  ======================================================",
    "   VARIABLE            CLASS.BASE            CLASS.COMP ",
    "  ------------------------------------------------------",
    "     DATE    c(\"A_DATE\", \"b_date\", \"cDate\")     Date    ",
    "  ------------------------------------------------------",
    ""
  ), `Different Modes` = c(
    "Differences found between the objects!",
    "", "A summary is given below.", "", "There are columns in BASE and COMPARE with different modes !!",
    "All rows are shown in table below", "", "  ================================",
    "   VARIABLE  MODE.BASE  MODE.COMP ", "  --------------------------------",
    "   INTEGER    numeric   character ", "  --------------------------------",
    "", "There are columns in BASE and COMPARE with different classes !!",
    "All rows are shown in table below", "", "  ==================================",
    "   VARIABLE  CLASS.BASE  CLASS.COMP ", "  ----------------------------------",
    "   INTEGER    integer    character  ", "  ----------------------------------",
    ""
  ), `Different Modes 2` = c(
    "Differences found between the objects!",
    "", "A summary is given below.", "", "There are columns in BASE and COMPARE with different modes !!",
    "All rows are shown in table below", "", "  ================================",
    "   VARIABLE  MODE.BASE  MODE.COMP ", "  --------------------------------",
    "   INTEGER   character   numeric  ", "  --------------------------------",
    "", "There are columns in BASE and COMPARE with different classes !!",
    "All rows are shown in table below", "", "  ==================================",
    "   VARIABLE  CLASS.BASE  CLASS.COMP ", "  ----------------------------------",
    "   INTEGER   character    integer   ", "  ----------------------------------",
    ""
  ), `Missing Columns` = c(
    "Differences found between the objects!",
    "", "A summary is given below.", "", "There are columns in BASE and COMPARE with different modes !!",
    "All rows are shown in table below", "", "  ================================",
    "   VARIABLE  MODE.BASE  MODE.COMP ", "  --------------------------------",
    "   INTEGER    numeric   character ", "  --------------------------------",
    "", "There are columns in BASE and COMPARE with different classes !!",
    "All rows are shown in table below", "", "  ==================================",
    "   VARIABLE  CLASS.BASE  CLASS.COMP ", "  ----------------------------------",
    "   INTEGER    integer    character  ", "  ----------------------------------",
    "", "There are columns in BASE that are not in COMPARE !!",
    "All rows are shown in table below", "", "  =========", "   COLUMNS ",
    "  ---------", "   BINARY  ", "  ---------", ""
  ), `Missing Columns 2` = c(
    "Differences found between the objects!",
    "", "A summary is given below.", "", "There are columns in BASE and COMPARE with different modes !!",
    "All rows are shown in table below", "", "  ================================",
    "   VARIABLE  MODE.BASE  MODE.COMP ", "  --------------------------------",
    "   INTEGER   character   numeric  ", "  --------------------------------",
    "", "There are columns in BASE and COMPARE with different classes !!",
    "All rows are shown in table below", "", "  ==================================",
    "   VARIABLE  CLASS.BASE  CLASS.COMP ", "  ----------------------------------",
    "   INTEGER   character    integer   ", "  ----------------------------------",
    "", "There are columns in BASE that are not in COMPARE !!",
    "All rows are shown in table below", "", "  =========", "   COLUMNS ",
    "  ---------", "   BINARY  ", "  ---------", ""
  ), `Missing Rows` = c(
    "Differences found between the objects!",
    "", "A summary is given below.", "", "There are rows in BASE that are not in COMPARE !!",
    "All rows are shown in table below", "", "  ===============",
    "   ..ROWNUMBER.. ", "  ---------------", "        11       ",
    "        12       ", "        13       ", "        14       ",
    "        15       ", "        16       ", "        17       ",
    "        18       ", "        19       ", "        20       ",
    "  ---------------", ""
  ), `Missing Rows 2` = c(
    "Differences found between the objects!",
    "", "A summary is given below.", "", "There are rows in BASE that are not in COMPARE !!",
    "All rows are shown in table below", "", "  ===============",
    "   ..ROWNUMBER.. ", "  ---------------", "        11       ",
    "        12       ", "        13       ", "        14       ",
    "        15       ", "        16       ", "        17       ",
    "        18       ", "        19       ", "        20       ",
    "  ---------------", ""
  ), everything = c(
    "Differences found between the objects!",
    "", "A summary is given below.", "", "There are columns in BASE and COMPARE with different modes !!",
    "All rows are shown in table below", "", "  ================================",
    "   VARIABLE  MODE.BASE  MODE.COMP ", "  --------------------------------",
    "   INTEGER    numeric   character ", "  --------------------------------",
    "", "There are columns in BASE and COMPARE with different classes !!",
    "All rows are shown in table below", "", "  ======================================================",
    "   VARIABLE  CLASS.BASE            CLASS.COMP           ",
    "  ------------------------------------------------------",
    "     DATE       Date     c(\"A_DATE\", \"b_date\", \"cDate\") ",
    "   INTEGER    integer              character            ",
    "  ------------------------------------------------------",
    "", "There are columns in BASE and COMPARE with differing attributes !!",
    "All rows are shown in table below", "", "  =============================================================================",
    "    VARIABLE    ATTR_NAME    VALUES.BASE                VALUES.COMP            ",
    "  -----------------------------------------------------------------------------",
    "     BINARY     something        NULL        list(Sepal.Length = c(5.1, 4.9... ",
    "   CATEGORICAL   levels    c(\"A\", \"B\", \"C\")          c(\"A\", \"B\", \"D\")          ",
    "    DATETIME      label          NULL        This is the label for my amazi... ",
    "  -----------------------------------------------------------------------------",
    "", "Not all Values Compared Equal", "All rows are shown in table below",
    "", "  ================================", "    Variable    No of Differences ",
    "  --------------------------------", "     GROUP2            20         ",
    "   CONTINUOUS           3         ", "   CATEGORICAL          8         ",
    "  --------------------------------", "", "", "First 10 of 20 rows are shown in table below",
    "", "  ========================================", "   VARIABLE  ..ROWNUMBER..  BASE  COMPARE ",
    "  ----------------------------------------", "    GROUP2         1          1     45    ",
    "    GROUP2         2          2     46    ", "    GROUP2         3          3     50    ",
    "    GROUP2         4          4     42    ", "    GROUP2         5          5     43    ",
    "    GROUP2         6          6     48    ", "    GROUP2         7          7     50    ",
    "    GROUP2         8          8     62    ", "    GROUP2         9          9     52    ",
    "    GROUP2        10         10     46    ", "  ----------------------------------------",
    "", "", "All rows are shown in table below", "", "  ==============================================",
    "    VARIABLE   ..ROWNUMBER..    BASE    COMPARE ", "  ----------------------------------------------",
    "   CONTINUOUS        1        15.65720     1    ", "   CONTINUOUS        5        26.15303     2    ",
    "   CONTINUOUS        7        16.29289     3    ", "  ----------------------------------------------",
    "", "", "All rows are shown in table below", "", "  ===========================================",
    "    VARIABLE    ..ROWNUMBER..  BASE  COMPARE ", "  -------------------------------------------",
    "   CATEGORICAL        1         C       D    ", "   CATEGORICAL        2         C       D    ",
    "   CATEGORICAL        3         C       D    ", "   CATEGORICAL        6         C       D    ",
    "   CATEGORICAL        7         C       D    ", "   CATEGORICAL       15         C       D    ",
    "   CATEGORICAL       17         C       D    ", "   CATEGORICAL       20         C       D    ",
    "  -------------------------------------------", ""
  ), `everything 2` = c(
    "Differences found between the objects!",
    "", "A summary is given below.", "", "There are columns in BASE and COMPARE with different modes !!",
    "All rows are shown in table below", "", "  ================================",
    "   VARIABLE  MODE.BASE  MODE.COMP ", "  --------------------------------",
    "   INTEGER   character   numeric  ", "  --------------------------------",
    "", "There are columns in BASE and COMPARE with different classes !!",
    "All rows are shown in table below", "", "  ======================================================",
    "   VARIABLE            CLASS.BASE            CLASS.COMP ",
    "  ------------------------------------------------------",
    "     DATE    c(\"A_DATE\", \"b_date\", \"cDate\")     Date    ",
    "   INTEGER             character              integer   ",
    "  ------------------------------------------------------",
    "", "There are columns in BASE and COMPARE with differing attributes !!",
    "All rows are shown in table below", "", "  =============================================================================",
    "    VARIABLE    ATTR_NAME             VALUES.BASE               VALUES.COMP    ",
    "  -----------------------------------------------------------------------------",
    "     BINARY     something  list(Sepal.Length = c(5.1, 4.9...        NULL       ",
    "   CATEGORICAL   levels            c(\"A\", \"B\", \"D\")           c(\"A\", \"B\", \"C\") ",
    "    DATETIME      label    This is the label for my amazi...        NULL       ",
    "  -----------------------------------------------------------------------------",
    "", "Not all Values Compared Equal", "All rows are shown in table below",
    "", "  ================================", "    Variable    No of Differences ",
    "  --------------------------------", "     GROUP2            20         ",
    "   CONTINUOUS           3         ", "   CATEGORICAL          8         ",
    "  --------------------------------", "", "", "First 10 of 20 rows are shown in table below",
    "", "  ========================================", "   VARIABLE  ..ROWNUMBER..  BASE  COMPARE ",
    "  ----------------------------------------", "    GROUP2         1         45      1    ",
    "    GROUP2         2         46      2    ", "    GROUP2         3         50      3    ",
    "    GROUP2         4         42      4    ", "    GROUP2         5         43      5    ",
    "    GROUP2         6         48      6    ", "    GROUP2         7         50      7    ",
    "    GROUP2         8         62      8    ", "    GROUP2         9         52      9    ",
    "    GROUP2        10         46     10    ", "  ----------------------------------------",
    "", "", "All rows are shown in table below", "", "  ===========================================",
    "    VARIABLE   ..ROWNUMBER..  BASE  COMPARE  ", "  -------------------------------------------",
    "   CONTINUOUS        1         1    15.65720 ", "   CONTINUOUS        5         2    26.15303 ",
    "   CONTINUOUS        7         3    16.29289 ", "  -------------------------------------------",
    "", "", "All rows are shown in table below", "", "  ===========================================",
    "    VARIABLE    ..ROWNUMBER..  BASE  COMPARE ", "  -------------------------------------------",
    "   CATEGORICAL        1         D       C    ", "   CATEGORICAL        2         D       C    ",
    "   CATEGORICAL        3         D       C    ", "   CATEGORICAL        6         D       C    ",
    "   CATEGORICAL        7         D       C    ", "   CATEGORICAL       15         D       C    ",
    "   CATEGORICAL       17         D       C    ", "   CATEGORICAL       20         D       C    ",
    "  -------------------------------------------", ""
  ), `Missing Vs NA` = c(
    "Differences found between the objects!",
    "", "A summary is given below.", "", "Not all Values Compared Equal",
    "All rows are shown in table below", "", "  ==============================",
    "   Variable   No of Differences ", "  ------------------------------",
    "   CHARACTER          1         ", "  ------------------------------",
    "", "", "All rows are shown in table below", "", "  =========================================",
    "   VARIABLE   ..ROWNUMBER..  BASE  COMPARE ", "  -----------------------------------------",
    "   CHARACTER        1        <NA>          ", "  -----------------------------------------",
    ""
  ), `With 1 key` = c(
    "Differences found between the objects!",
    "", "A summary is given below.", "", "There are columns in BASE and COMPARE with different modes !!",
    "All rows are shown in table below", "", "  ================================",
    "   VARIABLE  MODE.BASE  MODE.COMP ", "  --------------------------------",
    "   INTEGER    numeric   character ", "  --------------------------------",
    "", "There are columns in BASE and COMPARE with different classes !!",
    "All rows are shown in table below", "", "  ======================================================",
    "   VARIABLE  CLASS.BASE            CLASS.COMP           ",
    "  ------------------------------------------------------",
    "     DATE       Date     c(\"A_DATE\", \"b_date\", \"cDate\") ",
    "   INTEGER    integer              character            ",
    "  ------------------------------------------------------",
    "", "There are columns in BASE and COMPARE with differing attributes !!",
    "All rows are shown in table below", "", "  =============================================================================",
    "    VARIABLE    ATTR_NAME    VALUES.BASE                VALUES.COMP            ",
    "  -----------------------------------------------------------------------------",
    "     BINARY     something        NULL        list(Sepal.Length = c(5.1, 4.9... ",
    "   CATEGORICAL   levels    c(\"A\", \"B\", \"C\")          c(\"A\", \"B\", \"D\")          ",
    "    DATETIME      label          NULL        This is the label for my amazi... ",
    "  -----------------------------------------------------------------------------",
    "", "Not all Values Compared Equal", "All rows are shown in table below",
    "", "  ================================", "    Variable    No of Differences ",
    "  --------------------------------", "     GROUP2            20         ",
    "   CONTINUOUS           3         ", "   CATEGORICAL          8         ",
    "  --------------------------------", "", "", "First 10 of 20 rows are shown in table below",
    "", "  =============================", "   VARIABLE  ID  BASE  COMPARE ",
    "  -----------------------------", "    GROUP2    1    1     45    ",
    "    GROUP2    2    2     46    ", "    GROUP2    3    3     50    ",
    "    GROUP2    4    4     42    ", "    GROUP2    5    5     43    ",
    "    GROUP2    6    6     48    ", "    GROUP2    7    7     50    ",
    "    GROUP2    8    8     62    ", "    GROUP2    9    9     52    ",
    "    GROUP2   10   10     46    ", "  -----------------------------",
    "", "", "All rows are shown in table below", "", "  ===================================",
    "    VARIABLE   ID    BASE    COMPARE ", "  -----------------------------------",
    "   CONTINUOUS  1   15.65720     1    ", "   CONTINUOUS  5   26.15303     2    ",
    "   CONTINUOUS  7   16.29289     3    ", "  -----------------------------------",
    "", "", "All rows are shown in table below", "", "  ================================",
    "    VARIABLE    ID  BASE  COMPARE ", "  --------------------------------",
    "   CATEGORICAL   1   C       D    ", "   CATEGORICAL   2   C       D    ",
    "   CATEGORICAL   3   C       D    ", "   CATEGORICAL   6   C       D    ",
    "   CATEGORICAL   7   C       D    ", "   CATEGORICAL  15   C       D    ",
    "   CATEGORICAL  17   C       D    ", "   CATEGORICAL  20   C       D    ",
    "  --------------------------------", ""
  ), `With 2 keys` = c(
    "Differences found between the objects!",
    "", "A summary is given below.", "", "There are columns in BASE and COMPARE with different modes !!",
    "All rows are shown in table below", "", "  ================================",
    "   VARIABLE  MODE.BASE  MODE.COMP ", "  --------------------------------",
    "   INTEGER    numeric   character ", "  --------------------------------",
    "", "There are columns in BASE and COMPARE with different classes !!",
    "All rows are shown in table below", "", "  ======================================================",
    "   VARIABLE  CLASS.BASE            CLASS.COMP           ",
    "  ------------------------------------------------------",
    "     DATE       Date     c(\"A_DATE\", \"b_date\", \"cDate\") ",
    "   INTEGER    integer              character            ",
    "  ------------------------------------------------------",
    "", "There are columns in BASE and COMPARE with differing attributes !!",
    "All rows are shown in table below", "", "  =============================================================================",
    "    VARIABLE    ATTR_NAME    VALUES.BASE                VALUES.COMP            ",
    "  -----------------------------------------------------------------------------",
    "     BINARY     something        NULL        list(Sepal.Length = c(5.1, 4.9... ",
    "   CATEGORICAL   levels    c(\"A\", \"B\", \"C\")          c(\"A\", \"B\", \"D\")          ",
    "    DATETIME      label          NULL        This is the label for my amazi... ",
    "  -----------------------------------------------------------------------------",
    "", "Not all Values Compared Equal", "All rows are shown in table below",
    "", "  ================================", "    Variable    No of Differences ",
    "  --------------------------------", "     GROUP2            20         ",
    "   CONTINUOUS           3         ", "   CATEGORICAL          8         ",
    "  --------------------------------", "", "", "First 10 of 20 rows are shown in table below",
    "", "  =====================================", "   VARIABLE  ID  GROUP1  BASE  COMPARE ",
    "  -------------------------------------", "    GROUP2    1    1       1     45    ",
    "    GROUP2    2    1       2     46    ", "    GROUP2    3    1       3     50    ",
    "    GROUP2    4    1       4     42    ", "    GROUP2    5    1       5     43    ",
    "    GROUP2    6    1       6     48    ", "    GROUP2    7    1       7     50    ",
    "    GROUP2    8    1       8     62    ", "    GROUP2    9    1       9     52    ",
    "    GROUP2   10    1      10     46    ", "  -------------------------------------",
    "", "", "All rows are shown in table below", "", "  ===========================================",
    "    VARIABLE   ID  GROUP1    BASE    COMPARE ", "  -------------------------------------------",
    "   CONTINUOUS  1     1     15.65720     1    ", "   CONTINUOUS  5     1     26.15303     2    ",
    "   CONTINUOUS  7     1     16.29289     3    ", "  -------------------------------------------",
    "", "", "All rows are shown in table below", "", "  ========================================",
    "    VARIABLE    ID  GROUP1  BASE  COMPARE ", "  ----------------------------------------",
    "   CATEGORICAL   1    1      C       D    ", "   CATEGORICAL   2    1      C       D    ",
    "   CATEGORICAL   3    1      C       D    ", "   CATEGORICAL   6    1      C       D    ",
    "   CATEGORICAL   7    1      C       D    ", "   CATEGORICAL  15    2      C       D    ",
    "   CATEGORICAL  17    2      C       D    ", "   CATEGORICAL  20    2      C       D    ",
    "  ----------------------------------------", ""
  )
)
```


## generate_keyname()

```{r generate_keyname}
generate_keyname <- function(BASE, COMP,
                             replace_names = c(
                               "..ROWNUMBER..", "..RN..",
                               "..ROWN..", "..N.."
                             )) {
  if (class(replace_names) != "character") {
    stop("replace_names is not a character vector")
  }

  if (length(replace_names) == 0) {
    stop("All default row names are in use in BASE/COMPARE. Please provide a KEY argument")
  }

  key_name <- replace_names[1]

  if (!is.null(BASE[[key_name]]) | !is.null(COMP[[key_name]])) {
    key_name <- generate_keyname(BASE, COMP, replace_names[-1])
  }

  return(key_name)
}
```

# cast variables 

## sort_then_join()

```{r sort_then_join}
sort_then_join <- function(string1, string2) {
  paste0(sort(c(string1, string2)), collapse = "")
}
```

## class_merge()

```{r class_merge}
class_merge <- function(x) {
  paste(class(x), collapse = "_")
}
```

## get_message()

```{r get_message}
get_message <- function(colname, whichdat, totype) {
  message(paste0(
    "NOTE: Variable ", colname, " in ", tolower(whichdat), " was casted to ", totype
  ))
}
```

## get_casted_vector()

```{r get_casted_vector}
get_casted_vector <- function(colin, colname, whichdat) {
  if (class(colin) == "factor") {
    get_message(colname, whichdat, "character")
    return(as.character(colin))
  }

  if (class(colin) == "integer") {
    get_message(colname, whichdat, "numeric")
    return(as.numeric(colin))
  }

  colin
}
```

## get_casted_dataset()

```{r get_casted_dataset}
get_casted_dataset <- function(df, columns, whichdat) {
  for (col in columns) {
    df[[col]] <- get_casted_vector(df[[col]], col, whichdat)
  }
  return(df)
}
```

## cast_variables()

```{r cast_variables}
cast_variables <- function(BASE,
                           COMPARE,
                           ignore_vars = NULL,
                           cast_integers = FALSE,
                           cast_factors = FALSE) {
  allowed_class_casts <- c("integernumeric", "characterfactor")[c(cast_integers, cast_factors)]

  BASE_class <- data.frame(
    class_BASE = sapply(BASE, class_merge),
    colname = names(BASE),
    stringsAsFactors = FALSE
  )
  BASE_class <- BASE_class[!BASE_class[["colname"]] %in% ignore_vars, , drop = FALSE]


  COMPARE_class <- data.frame(
    class_COMPARE = sapply(COMPARE, class_merge),
    colname = names(COMPARE),
    stringsAsFactors = FALSE
  )
  COMPARE_class <- COMPARE_class[!COMPARE_class[["colname"]] %in% ignore_vars, , drop = FALSE]

  common_class <- merge(
    x = BASE_class,
    y = COMPARE_class,
    by = "colname"
  )


  diff_class <- common_class[common_class[["class_BASE"]] != common_class[["class_COMPARE"]], , drop = FALSE]


  diff_class$classmerge <- mapply(
    sort_then_join,
    diff_class$class_COMPARE,
    diff_class$class_BASE
  )


  cast_columns <- diff_class[diff_class[["classmerge"]] %in% allowed_class_casts, , drop = FALSE]


  DATASETS <- list(
    "BASE" = BASE,
    "COMPARE" = COMPARE
  )


  if (nrow(cast_columns) == 0) {
    return(DATASETS)
  }


  for (i in names(DATASETS)) {
    DATASETS[[i]] <- get_casted_dataset(DATASETS[[i]], cast_columns$colname, i)
  }


  return(DATASETS)
}
```


# issues

## construct_issue()

The first function we'll look at is `construct_issue()`

```{r construct_issue}
construct_issue <- function(value, message, add_class = NULL) {
  x <- value

  ### If nothing has been provided return nothing !
  if (nrow(x) == 0) {
    return(NULL)
  }

  class(x) <- c(add_class, "issue", class(x))
  attributes(x)[["message"]] <- message
  return(x)
}
```

```{r test-construct_issue}
construct_issue(
  value = compare,
  message = "this is a test message",
  add_class = "diffdf"
) |> str()
```

```{r get_issue_message}
get_issue_message <- function(object, ...) {
  return(attr(object, "message"))
}
```

```{r get_print_message}
get_print_message <- function(object, ...) {
  UseMethod("get_print_message", object)
}
```

```{r get_print_message.default}
get_print_message.default <- function(object) {
  stop("Error: An issue has not been provided to this function!")
}
```

```{r get_print_message.issue}
get_print_message.issue <- function(object) {
  paste(
    c(attr(object, "message"), get_table(object)),
    collapse = "\n"
  )
}
```


## diffdf_has_issues()

The `diffdf_has_issues()` tests if

```{r diffdf_has_issues}
diffdf_has_issues <- function(x) {
  if (class(x)[[1]] != "diffdf") stop("x is not an diffdf object")
  return(length(x) != 0)
}
```

## get_issue_dataset(0)

```{r get_issue_dataset}
get_issue_dataset <- function(issue, diff) {
  issue_df <- diff[[issue]]
  keep <- names(issue_df)[!(names(issue_df) %in% c("BASE", "COMPARE", "VARIABLE"))]
  issue_df[, keep, drop = FALSE]
}
```

## diffdf_issuerows()

```{r diffdf_issuerows}
diffdf_issuerows <- function(df, diff, vars = NULL) {
  if (class(diff)[[1]] != "diffdf") {
    stop("diff should be an diffdf object")
  }

  KEYS_ATT <- attr(diff, "keys")

  if (is.null(KEYS_ATT)) {
    stop("diff is missing the keys attribute")
  }

  issue_vars <- names(diff)[grep("^VarDiff_", names(diff))]

  if (is.null(vars)) {
    vars <- issue_vars
  } else {
    vars <- paste0("VarDiff_", vars)
  }

  if (length(issue_vars) == 0 | sum(vars %in% issue_vars) == 0) {
    return(df[FALSE, ])
  }

  KEEP <- mapply(
    FUN      = get_issue_dataset,
    issue    = vars,
    diff     = list(diff),
    SIMPLIFY = F
  )

  KEEP <- recursive_reduce(KEEP, rbind)
  KEEP <- KEEP[!duplicated(KEEP), ]

  if (KEYS_ATT$is_derived) {
    df[[KEYS_ATT$value]] <- 1:nrow(df)
  }

  keys <- KEYS_ATT$value

  if (any(!keys %in% names(df))) {
    stop("df does not contain all variables specified as keys in diff")
  }

  RET <- merge(
    x = df,
    y = KEEP,
    sort = TRUE
  )

  RET <- RET[do.call("order", RET[keys]), ]

  if (KEYS_ATT$is_derived) {
    keep_vars <- !names(RET) %in% KEYS_ATT$value
    RET <- RET[, keep_vars, drop = FALSE]
  }

  return(RET)
}
```





# identify

## identify_extra_rows()

```{r identify_extra_rows}
identify_extra_rows <- function(DS1, DS2, KEYS) {
  DS2[["..FLAG.."]] <- "Y"
  dat <- merge(
    subset(DS1, select = KEYS),
    subset(DS2, select = c(KEYS, "..FLAG..")),
    by = KEYS, all.x = T,
    sort = TRUE
  )
  dat <- dat[do.call("order", dat[KEYS]), ]

  dat[is.na(dat[["..FLAG.."]]), KEYS, drop = FALSE]
}
```

## identify_extra_cols()

```{r identify_extra_cols}
identify_extra_cols <- function(DS1, DS2) {
  match.cols <- sapply(names(DS1), "%in%", names(DS2))
  if (!all(is.logical(match.cols))) {
    stop("Assumption of logical return type is not true")
  }
  tibble(
    COLUMNS = names(DS1)[!match.cols]
  )
}
```

## identify_matching_cols()

```{r identify_matching_cols}
identify_matching_cols <- function(DS1, DS2, EXCLUDE = "") {
  match_cols <- sapply(names(DS1), "%in%", names(DS2))
  exclude_cols <- sapply(names(DS1), "%in%", EXCLUDE)
  names(DS1)[match_cols & !exclude_cols]
}
```

## identify_mode_differences()

```{r identify_mode_differences}
identify_mode_differences <- function(BASE, COMP) {
  matching_cols <- identify_matching_cols(BASE, COMP)

  dat <- merge(
    x = identify_properties(BASE),
    y = identify_properties(COMP),
    by = "VARIABLE",
    all = TRUE,
    suffixes = c(".BASE", ".COMP"),
    sort = TRUE
  )
  dat <- subset(dat, select = c("VARIABLE", "MODE.BASE", "MODE.COMP"))

  KEEP1 <- dat[["VARIABLE"]] %in% matching_cols
  KEEP2 <- dat[["MODE.BASE"]] != dat[["MODE.COMP"]]

  dat[KEEP1 & KEEP2, , drop = FALSE]
}
```

## identify_properties()

```{r identify_properties}
identify_properties <- function(dsin) {

  ### If missing or null return empty dataset
  if (is.null(dsin)) {
    x <- tibble(
      VARIABLE = character(),
      CLASS = list(),
      MODE = character(),
      TYPE = character(),
      ATTRIBS = list()
    )
    return(x)
  }

  tibble(
    VARIABLE = names(dsin),
    CLASS = lapply(dsin, class),
    MODE = sapply(dsin, mode),
    TYPE = sapply(dsin, typeof),
    ATTRIBS = lapply(dsin, attributes)
  )
}
```


## identify_unsupported_cols()

```{r identify_unsupported_cols}
identify_unsupported_cols <- function(dsin) {
  dat <- subset(
    identify_properties(dsin),
    select = c("VARIABLE", "MODE")
  )

  dat[!dat[["MODE"]] %in% c("numeric", "character", "logical"), , drop = FALSE]
}
```

## identify_class_differences()

```{r identify_class_differences}
identify_class_differences <- function(BASE, COMP) {
  matching_cols <- identify_matching_cols(BASE, COMP)

  dat <- merge(
    x = identify_properties(BASE),
    y = identify_properties(COMP),
    by = "VARIABLE",
    all = TRUE,
    sort = TRUE,
    suffixes = c(".BASE", ".COMP")
  )

  dat <- subset(dat, select = c("VARIABLE", "CLASS.BASE", "CLASS.COMP"))

  KEEP1 <- dat[["VARIABLE"]] %in% matching_cols
  KEEP2 <- !mapply(
    identical,
    dat[["CLASS.BASE"]],
    dat[["CLASS.COMP"]]
  )

  dat[KEEP1 & KEEP2, , drop = FALSE]
}
```

## identify_att_differences()

```{r identify_att_differences}
identify_att_differences <- function(BASE, COMP, exclude_cols = "") {
  matching_cols <- identify_matching_cols(BASE, COMP, exclude_cols)

  PROPS <- merge(
    x = identify_properties(BASE),
    y = identify_properties(COMP),
    by = "VARIABLE",
    all = TRUE,
    sort = TRUE,
    suffixes = c(".BASE", ".COMP")
  )

  PROPS <- subset(PROPS, select = c("VARIABLE", "ATTRIBS.BASE", "ATTRIBS.COMP"))

  PROPS <- PROPS[PROPS[["VARIABLE"]] %in% matching_cols, , drop = FALSE]


  ### Setup dummy return value
  RETURN <- tibble(
    VARIABLE = character(),
    ATTR_NAME = character(),
    VALUES.BASE = list(),
    VALUES.COMP = list()
  )

  for (i in PROPS[["VARIABLE"]]) {
    PROPS_filt <- PROPS[PROPS[["VARIABLE"]] == i, , drop = FALSE]

    ### Get a vector of all available attributes across both variables
    ATTRIB_NAMES <- unique(c(
      names(PROPS_filt[["ATTRIBS.BASE"]][[1]]),
      names(PROPS_filt[["ATTRIBS.COMP"]][[1]])
    ))

    ### If variable has no attributes move onto the next variable
    if (is.null(ATTRIB_NAMES)) next()

    ### Loop over each attribute checking if they are identical and outputing
    ### anyones that arn't
    for (j in ATTRIB_NAMES) {
      ATTRIB_BASE <- PROPS_filt[["ATTRIBS.BASE"]][[1]][j]
      ATTRIB_COMP <- PROPS_filt[["ATTRIBS.COMP"]][[1]][j]

      if (!identical(ATTRIB_BASE, ATTRIB_COMP)) {
        ATT_DIFFS <- tibble(
          VARIABLE = i,
          ATTR_NAME = j,
          VALUES.BASE = ifelse(is.null(ATTRIB_BASE), list(), ATTRIB_BASE),
          VALUES.COMP = ifelse(is.null(ATTRIB_COMP), list(), ATTRIB_COMP)
        )

        RETURN <- rbind(RETURN, ATT_DIFFS)
      }
    }
  }
  return(RETURN)
}
```

## identify_differences()

```{r identify_differences}
identify_differences <- function(BASE, COMP, KEYS, exclude_cols,
                                 tolerance = sqrt(.Machine$double.eps),
                                 scale = NULL) {
  matching_cols <- identify_matching_cols(BASE, COMP, c(KEYS, exclude_cols))

  if (length(matching_cols) == 0) {
    return(tibble())
  }

  DAT <- merge(
    x = BASE,
    y = COMP,
    by = KEYS,
    suffix = c(".x", ".y"),
    sort = TRUE
  )
  DAT <- DAT[do.call("order", DAT[KEYS]), ]


  matching_list <- mapply(
    is_variable_different,
    matching_cols,
    MoreArgs = list(
      keynames = KEYS,
      datain = DAT,
      tolerance = tolerance,
      scale = scale
    ),
    SIMPLIFY = FALSE
  )

  matching_list
}
```

# misc functions

## factor_to_character()

```{r factor_to_character}
factor_to_character <- function(dsin, vars = NULL) {
  if (is.null(vars)) vars <- names(dsin)

  for (var in vars) {
    if (is.factor(dsin[[var]])) {
      dsin[[var]] <- as.character(dsin[[var]])
    }
  }
  return(dsin)
}
```

## has_unique_rows()

The next function we'll check is `has_unique_rows()` , which tests to see if the rows are duplicated.

```{r has_unique_rows}
has_unique_rows <- function(DAT, KEYS) {
  DUPS <- duplicated(subset(DAT, select = KEYS))
  NDUPS <- sum(DUPS)
  return(NDUPS == 0)
}
```

To test this we'll need a dataset with duplicated rows, which should test as `FALSE`

```{r duplicates}
duplicates <- dplyr::bind_rows(
  head(compare, 2),
  head(compare, 2)
)
```

```{r has_unique_rows-dups}
has_unique_rows(DAT = duplicates, KEYS = "join_var")
```

Both of these should test as `TRUE`

```{r has_unique_rows-compare-base}
has_unique_rows(DAT = base, KEYS = "join_var")
has_unique_rows(DAT = compare, KEYS = "join_var")
```

## convert_to_issue()

```{r convert_to_issue}
convert_to_issue <- function(datin) {
  datin_tibble <- tibble(
    `Variable` = names(datin),
    `No of Differences` = datin
  )

  datin_tibble_reduced <- datin_tibble[datin_tibble[["No of Differences"]] > 0, , drop = FALSE]
  return(datin_tibble_reduced)
}
```


## is_variable_different()

```{r is_variable_different}
is_variable_different <- function(variablename, keynames, datain, ...) {
  xvar <- paste0(variablename, ".x")
  yvar <- paste0(variablename, ".y")

  if (!xvar %in% names(datain) | !yvar %in% names(datain)) {
    stop("Variable does not exist within input dataset")
  }

  target <- datain[[xvar]]
  current <- datain[[yvar]]
  outvect <- find_difference(target, current, ...)

  datain[["VARIABLE"]] <- variablename

  names(datain)[names(datain) %in% c(xvar, yvar)] <- c("BASE", "COMPARE")

  x <- as_tibble(
    subset(
      datain,
      outvect,
      select = c("VARIABLE", keynames, "BASE", "COMPARE")
    )
  )

  return(x)
}
```

## find_difference()

```{r find_difference}
find_difference <- function(target, current, ...) {
  if (length(target) != length(current)) {
    warning("Inputs are not of the same length")
    return(NULL)
  }

  if (is.null(target) | is.null(current)) {
    return(is.null(target) != is.null(current))
  }

  ### Initalise output, assume problem unless evidence otherwise
  return_vector <- rep(TRUE, length(target))

  nas_t <- is.na(target)
  nas_c <- is.na(current)

  ## compare missing values
  nacompare <- nas_t != nas_c
  naselect <- nas_t | nas_c
  return_vector[naselect] <- nacompare[naselect]

  ## compare non-missing values
  selectvector <- as.logical((!nas_t) * (!nas_c))

  comparevect <- compare_vectors(
    target[selectvector],
    current[selectvector],
    ...
  )

  return_vector[selectvector] <- comparevect

  return(return_vector)
}
```



## compare_vectors.default()

```{r compare_vectors.default}
compare_vectors.default <- function(target, current, ...) {
  target != current
}
```

## compare_vectors.factor()

```{r compare_vectors.factor}
compare_vectors.factor <- function(target, current, ...) {
  as.character(target) != as.character(current)
}
```

## compare_vectors.numeric()

```{r compare_vectors.numeric}
compare_vectors.numeric <- function(target,
                                    current,
                                    tolerance = sqrt(.Machine$double.eps),
                                    scale = NULL) {
  out <- target == current

  if (all(out)) {
    return(!out)
  }

  if (is.integer(target) || is.integer(current)) {
    target <- as.double(target)
    current <- as.double(current)
  }

  xy <- abs(target - current)

  if (!is.null(scale)) {
    xy <- xy / scale
  }

  return(xy > tolerance)
}
```

## compare_vectors()

```{r compare_vectors}
compare_vectors <- function(target, current, ...) {
  UseMethod("compare_vectors")
}
```

## print.diffdf()

```{r print.diffdf}
print.diffdf <- function(x, ..., as_string = FALSE) {
  COMPARE <- x

  if (length(COMPARE) == 0) {
    outtext <- "No issues were found!\n"
  } else {
    start_text <- paste0(
      "Differences found between the objects!\n\n",
      "A summary is given below.\n\n"
    )

    end_text <- lapply(COMPARE, function(x) get_print_message(x))
    end_text <- paste0(unlist(end_text), collapse = "")

    outtext <- paste0(start_text, end_text)
  }

  if (as_string) {
    return(strsplit(outtext, "\n")[[1]])
  } else {
    cat(outtext)
    return(invisible(COMPARE))
  }
}
```

```{r ascii-tables}
string_pad <- function(x, width) {
  if (nchar(x) >= width) {
    return(x)
  }
  width <- width - nchar(x)
  left <- paste0(rep(" ", floor(width / 2)), collapse = "")
  right <- paste0(rep(" ", ceiling(width / 2)), collapse = "")
  paste0(left, x, right, collapse = "")
}

recursive_reduce <- function(.l, .f) {
  if (length(.l) != 1) {
    .l[[2]] <- .f(.l[[1]], .l[[2]])
    return(recursive_reduce(.l[-1], .f))
  } else {
    return(.l[[1]])
  }
}

#' invert
#'
#' Utility function used to replicated purrr::transpose. Turns a list inside
#' out.
#' @param x list
invert <- function(x) {
  x2 <- list()
  cnames <- names(x)
  tnames <- names(x[[1]])
  for (i in tnames) {
    x2[[i]] <- list()
    for (j in cnames) {
      x2[[i]][[j]] <- x[[j]][[i]]
    }
  }
  return(x2)
}

as_ascii_table <- function(dat, line_prefix = "  ") {


  ## Convert every value to character and crop to a suitable length
  dat <- as_tibble(apply(dat, c(1, 2), as_cropped_char))

  hold <- list()
  COLS <- colnames(dat)

  ### For each column extract core elements (width, values , title) and pad out
  ### each string to be a suitable length
  for (i in 1:ncol(dat)) {
    COL <- COLS[i]
    VALUES <- dat[[i]]

    JOINT <- c(COL, VALUES)
    WIDTH <- max(sapply(JOINT, nchar)) + 2

    hold[[COL]] <- list()
    hold[[COL]]$WIDTH <- WIDTH
    hold[[COL]]$VALUES <- sapply(VALUES, string_pad, width = WIDTH)
    hold[[COL]]$HEADER <- sapply(COL, string_pad, width = WIDTH)
  }

  ### Collapse into a single value per component ( title , values, width )
  thold <- invert(hold)
  tvals <- recursive_reduce(thold$VALUES, paste0)
  thead <- recursive_reduce(thold$HEADER, paste0)
  twidth <- recursive_reduce(thold$WIDTH, sum)

  ### Create header and footer lines
  TLINE <- paste0(rep("=", twidth), collapse = "")
  LINE <- paste0(rep("-", twidth), collapse = "")
  FVALS <- paste0(line_prefix, tvals, collapse = "\n")

  ### Output table
  paste0(
    "\n",
    line_prefix, TLINE, "\n",
    line_prefix, thead, "\n",
    line_prefix, LINE, "\n",
    FVALS, "\n",
    line_prefix, LINE
  )
}

as_cropped_char <- function(inval, crop_at = 30) {
  if (is.null(inval)) {
    inval <- "<NULL>"
  } else if (is.na(inval)) {
    inval <- "<NA>"
  } else {
    inval <- as.character(inval)
  }

  charlength <- sapply(inval, nchar)

  if (charlength > crop_at) {
    outval <- substr(inval, 1, crop_at)
    outval <- paste0(outval, "...")
  } else {
    outval <- inval
  }

  outval
}
get_table <- function(dsin, row_limit = 10) {
  if (nrow(dsin) == 0) {
    return("")
  }

  display_table <- subset(dsin, 1:nrow(dsin) < (row_limit + 1))

  if (nrow(dsin) > row_limit) {
    add_message <- paste0(
      "First ",
      row_limit,
      " of ",
      nrow(dsin),
      " rows are shown in table below"
    )
  } else {
    add_message <- "All rows are shown in table below"
  }

  msg <- paste(
    c(
      add_message,
      as_ascii_table(display_table),
      "\n"
    ),
    collapse = "\n"
  )

  return(msg)
}
```


# diffdf()

```{r diffdf}
diffdf <- function(base,
                   compare,
                   keys = NULL,
                   suppress_warnings = FALSE,
                   strict_numeric = TRUE,
                   strict_factor = TRUE,
                   file = NULL,
                   tolerance = sqrt(.Machine$double.eps),
                   scale = NULL) {
  BASE <- base
  COMP <- compare
  KEYS <- keys
  SUPWARN <- suppress_warnings


  ### Initatiate output object
  COMPARE <- list()
  class(COMPARE) <- c("diffdf", "list")

  is_derived <- FALSE

  ### If no key is suplied match values based upon row number
  if (is.null(KEYS)) {
    is_derived <- TRUE
    keyname <- generate_keyname(BASE, COMP)
    BASE[[keyname]] <- 1:nrow(BASE)
    COMP[[keyname]] <- 1:nrow(COMP)
    KEYS <- keyname
  }
  attr(COMPARE, "keys") <- list(value = KEYS, is_derived = is_derived)



  if (!is.numeric(tolerance)) {
    stop("'tolerance' should be numeric")
  }

  if (!is.numeric(scale) && !is.null(scale)) {
    stop("'scale' should be numeric or NULL")
  }



  if (!has_unique_rows(BASE, KEYS)) {
    stop("BY variables in BASE do not result in unique observations")
  }

  if (!has_unique_rows(COMP, KEYS)) {
    stop("BY variables in COMPARE do not result in unique observations")
  }



  #### Check essential variable properties (class & mode)

  COMPARE[["UnsupportedColsBase"]] <- construct_issue(
    value = identify_unsupported_cols(BASE),
    message = "There are columns in BASE with unsupported modes !!"
  )


  COMPARE[["UnsupportedColsComp"]] <- construct_issue(
    value = identify_unsupported_cols(COMP),
    message = "There are columns in COMPARE with unsupported modes !!"
  )


  # cast variables if strict is off
  if (!strict_factor | !strict_numeric) {
    casted_df <- cast_variables(
      BASE = BASE,
      COMPARE = COMP,
      ignore_vars = KEYS,
      cast_integers = !strict_numeric,
      cast_factors = !strict_factor
    )

    BASE <- casted_df$BASE
    COMP <- casted_df$COMP
  }


  COMPARE[["VarModeDiffs"]] <- construct_issue(
    value = identify_mode_differences(BASE, COMP),
    message = "There are columns in BASE and COMPARE with different modes !!"
  )


  COMPARE[["VarClassDiffs"]] <- construct_issue(
    value = identify_class_differences(BASE, COMP),
    message = "There are columns in BASE and COMPARE with different classes !!"
  )


  exclude_cols <- c(
    COMPARE[["UnsupportedColsBase"]]$VARIABLE,
    COMPARE[["UnsupportedColsComp"]]$VARIABLE,
    COMPARE[["VarClassDiffs"]]$VARIABLE,
    COMPARE[["VarModeDiffs"]]$VARIABLE
  )


  ##### Check Validity of Keys

  BASE_keys <- names(BASE)[names(BASE) %in% KEYS]
  COMP_keys <- names(COMP)[names(COMP) %in% KEYS]


  if (length(BASE_keys) != length(KEYS)) {
    stop("BASE is missing variables specified in KEYS")
  }

  if (length(COMP_keys) != length(KEYS)) {
    stop("COMP is missing variables specified in KEYS")
  }

  if (any(KEYS %in% exclude_cols)) {
    stop("KEYS are either an invalid or contain different modes between BASE and COMP")
  }


  ##### Check Attributes


  COMPARE[["AttribDiffs"]] <- construct_issue(
    value = identify_att_differences(BASE, COMP, exclude_cols),
    message = "There are columns in BASE and COMPARE with differing attributes !!"
  )


  ##### Check data

  BASE <- factor_to_character(BASE, KEYS)
  COMP <- factor_to_character(COMP, KEYS)


  COMPARE[["ExtRowsBase"]] <- construct_issue(
    value = identify_extra_rows(BASE, COMP, KEYS),
    message = "There are rows in BASE that are not in COMPARE !!"
  )


  COMPARE[["ExtRowsComp"]] <- construct_issue(
    value = identify_extra_rows(COMP, BASE, KEYS),
    message = "There are rows in COMPARE that are not in BASE !!"
  )



  COMPARE[["ExtColsBase"]] <- construct_issue(
    value = identify_extra_cols(BASE, COMP),
    message = "There are columns in BASE that are not in COMPARE !!"
  )


  COMPARE[["ExtColsComp"]] <- construct_issue(
    value = identify_extra_cols(COMP, BASE),
    message = "There are columns in COMPARE that are not in BASE !!"
  )


  VALUE_DIFFERENCES <- identify_differences(
    BASE, COMP, KEYS, exclude_cols,
    tolerance = tolerance,
    scale = scale
  )



  ## Summarise the number of mismatching rows per variable

  if (length(VALUE_DIFFERENCES)) {
    NDIFF <- sapply(VALUE_DIFFERENCES, nrow)
    COMPARE[["NumDiff"]] <- construct_issue(
      value = convert_to_issue(NDIFF),
      message = "Not all Values Compared Equal"
    )
  }


  for (i in names(VALUE_DIFFERENCES)) {
    COMPARE[[paste0("VarDiff_", i)]] <- construct_issue(
      value = VALUE_DIFFERENCES[[i]],
      message = ""
    )
  }

  ## Get all issue messages, remove blank message, and collapse into single string
  ISSUE_MSGS <- sapply(COMPARE, function(x) get_issue_message(x))
  ISSUE_MSGS <- ISSUE_MSGS[ISSUE_MSGS != ""]

  if (length(ISSUE_MSGS) != 0) {
    if (!SUPWARN) {
      ISSUE_MSGS <- paste(ISSUE_MSGS, collapse = "\n")
      warning(c("\n", ISSUE_MSGS))
    }
  }


  if (!is.null(file)) {
    x <- print(COMPARE, as_string = TRUE)

    tryCatch(
      {
        sink(file)
        cat(x, sep = "\n")
        sink()
      },
      warning = function(w) {
        sink()
        warning(w)
      },
      error = function(e) {
        sink()
        stop(e)
      }
    )
    return(invisible(COMPARE))
  }

  return(COMPARE)
}
```

```{r}
diffdf(base = base, compare = compare, keys = "join_var")
```

```{r}
diffdf(base = base_change_df, compare = compare_change_df)
```
