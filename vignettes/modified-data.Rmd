---
title: "modified-data"
output: 
  rmarkdown::html_vignette:
    toc: yes
    toc_depth: 4
vignette: >
  %\VignetteIndexEntry{modified-data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
library(janitor) # compare_df_cols
library(arsenal) # comparedf
library(diffdf)  # diffdf
library(testthat) # expect_equal
library(vetr) # alike
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>", 
  error = TRUE
)
options(
  str = strOptions(strict.width = "wrap"),
  width = 75,
  rmarkdown.html_vignette.check_title = FALSE,
  tibble.print_max = Inf)
```

# Motivation

The goal of the `dfdiffs` is to answer the following questions:

1.  What rows are here now that weren't here before?
2.  What rows were here before that aren't here now?
3.  **What values have been changed?**

This vignette takes us through the `create_modified_data()` function, which answers the "*What values have been changed?*". We also have another function that detects modified data, `create_changed_data()`.

## Packages

```{r pkgs, message=FALSE, warning=FALSE, results='hide'}
library(dplyr)
library(stringr)
library(forcats)
library(lubridate)
library(fs)
library(vctrs)
library(glue)
library(purrr)
library(vroom)
library(haven)
library(readxl)
library(dfdiffs)
library(kableExtra)
```

## Changed data

We have two datasets to test what's been modified:

### Initial Data

```{r InitialData}
InitialData <- dfdiffs::InitialData
```

```{r InitialData-show, echo=FALSE}
knitr::kable(InitialData, caption = "InitialData") |> 
  kableExtra::kable_paper()
```

### Changed Data

```{r ChangedData}
ChangedData <- dfdiffs::ChangedData
```

```{r ChangedData-show, echo=FALSE}
knitr::kable(ChangedData, caption = "ChangedData") |> 
  kableExtra::kable_paper()
```

## Add join column

These data do not have a unique identifier, but we can create one with the `create_join_column()` function.


### InitialDataID

We create a join column using the `subject_id` and `record` columns.

```{r InitialDataID}
InitialDataID <- create_join_column(df = InitialData, 
  by_colums = c('subject_id', 'record'), 
  new_by_column_name = 'subrecid')
```

```{r InitialDataID-show, echo=FALSE}
knitr::kable(InitialDataID, caption = "InitialDataID") |> 
  kableExtra::kable_paper()
```

### ChangedDataID

We create an identical join column in the `ChangedData`

```{r ChangedDataID}
ChangedDataID <- create_join_column(df = ChangedData, 
  by_colums = c('subject_id', 'record'), 
  new_by_column_name = 'subrecid')
```

```{r ChangedDataID-show, echo=FALSE}
knitr::kable(ChangedDataID, caption = "ChangedDataID") |> 
  kableExtra::kable_paper()
```

Now we can test row-by-row comparisons and comparisons with a `by` column.

# `create_modified_data()`

The `create_modified_data()` function is a wrapper around `arsenal::comparedf()`, but only returns a small fraction of the output. 

```{r modified_cdf}
modified_cdf <- arsenal::comparedf(
  x = ChangedDataID,
  y = InitialDataID, 
  by = "subrecid")
```

This function also requires a call to `summary()` to clean up the output a bit. 

```{r modified_cdf_sum}
modified_cdf_sum <- summary(modified_cdf)
names(modified_cdf_sum)
```

We're only interested in the `diffs.byvar.table` and the `diffs.table`. 

## `comparedf()` -> `diffs.byvar.table`

```{r comparedf-diffs.byvar.table, eval=FALSE}
modified_cdf_sum$diffs.byvar.table
```

```{r , echo=FALSE}
knitr::kable(modified_cdf_sum$diffs.byvar.table, 
  caption = "modified_cdf_sum$diffs.byvar.table") |> 
  kableExtra::kable_paper()
```


## `comparedf()` -> `diffs.byvar.table`

```{r comparedf-diffs.table, eval=FALSE}
modified_cdf_sum$diffs.table
```

```{r , echo=FALSE}
knitr::kable(modified_cdf_sum$diffs.table, caption = "modified_cdf_sum$diffs.table") |> 
  kableExtra::kable_paper()
```

```{r create_modified_data}
modified <- create_modified_data(
  compare = ChangedDataID, 
  base = InitialDataID, 
  by = "subrecid")
names(modified)
```

## `create_modified_data()` -> `diffs_byvar`

We've removed the extra `var.y` (and renamed `var.x` to `Variable name`).

```{r modified-diffs_byvar, eval=FALSE}
modified$diffs_byvar
```

```{r , echo=FALSE}
knitr::kable(modified$diffs_byvar, caption = "modified$diffs_byvar") |> 
  kableExtra::kable_paper()
```


## `create_modified_data()` -> `diffs`

We've removed the `var.y` (and renamed `var.x` to `Variable name`). `values.x` was renamed to `Current Value`, and `values.y` was renamed to `	Previous Value`. 

We've also removed the row position variables (`row.x` and `row.y`)

```{r modified-diffs, eval=FALSE}
modified$diffs
```

```{r , echo=FALSE}
knitr::kable(modified$diffs, caption = "modified$diffs") |> 
  kableExtra::kable_paper()
```

